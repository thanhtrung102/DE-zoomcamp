id: backfill_green_2021
namespace: de-zoomcamp

description: |
  Backfill green taxi data for January through July 2021.
  Uses ForEach to iterate through months and trigger subflows.

tasks:
  - id: log_start
    type: io.kestra.plugin.core.log.Log
    message: "Starting backfill for Green Taxi 2021 (Jan-Jul)"

  - id: process_months
    type: io.kestra.plugin.core.flow.ForEach
    values: ["01", "02", "03", "04", "05", "06", "07"]
    tasks:
      - id: log_month
        type: io.kestra.plugin.core.log.Log
        message: "Processing month: {{ taskrun.value }}"

      - id: load_month
        type: io.kestra.plugin.core.flow.Subflow
        flowId: taxi_data_pipeline
        namespace: de-zoomcamp
        inputs:
          taxi: green
          year: "2021"
          month: "{{ taskrun.value }}"
        wait: true
        transmitFailed: true

  - id: log_complete
    type: io.kestra.plugin.core.log.Log
    message: "Backfill completed for Green Taxi 2021 (Jan-Jul)"
